---
description: Zasady projektu Next.js + Prisma – infrastruktura, baza danych, deploy (Hetzner + MyDevil backup)
alwaysApply: true
---

# Zasady projektu: Next.js + Prisma + Hetzner (produkcja)

## 1. Kontekst infrastruktury — WAŻNE!

### SERWER PRODUKCYJNY: Hetzner VPS (GŁÓWNY)

- **IP:** `65.108.245.25`
- **SSH:** `ssh hetzner` lub `ssh -i ~/.ssh/hetzner_key root@65.108.245.25`
- **Domena:** `hotel.karczma-labedz.pl`
- **OS:** Ubuntu 24.04
- **Node:** v20 LTS, zarządzany przez PM2
- **Baza danych:** MariaDB lokalna na serwerze
- **SSL:** Let's Encrypt (certbot, auto-odnawialny)

### MyDevil (BACKUP — nie używaj do produkcji!)

- MyDevil pozostaje jako backup, NIE wrzucaj tam nowych wersji
- Główna strona `karczma-labedz.pl` nadal jest na MyDevil
- Skrypt `deploy-to-mydevil.ps1` działa, ale używaj tylko w razie powrotu

## 2. Deploy na produkcję (Hetzner) — TYLKO PRZEZ GIT!

### JEDYNY sposób deployu:

```powershell
git add .
git commit -m "opis zmian"
git push origin master
```

**GitHub Actions automatycznie:**
1. Buduje aplikację
2. Wdraża na serwer Hetzner
3. Restartuje PM2

**WAŻNE — NIE UŻYWAJ:**
- ❌ `scripts/deploy-to-hetzner.ps1` — NIEAKTUALNY, nie używać!
- ❌ `scripts/git-deploy.ps1` — NIEAKTUALNY, nie używać!
- ❌ Żadnych innych skryptów deploy

**Sprawdzenie statusu deployu:**
- W GitHub → Actions → ostatni workflow
- Lub przez SSH: `ssh hetzner "pm2 logs hotel-pms --lines 50"`

## 3. Dane dostępowe Hetzner

**SSH:**
```
ssh hetzner
```

**Baza danych:**
- Host: localhost
- User: hotel
- Pass: HotelPMS2024#Secure
- DB: hotel_pms
- URL: `mysql://hotel:HotelPMS2024#Secure@localhost/hotel_pms`

**PM2:**
```bash
pm2 list              # status
pm2 logs hotel-pms    # logi
pm2 restart hotel-pms # restart
```

## 4. Zarządzanie bazą danych

### Lokalnie (Windows)

1. Po edycji `schema.prisma` uruchom: `npx prisma db push`.
2. Wygeneruj klienta: `npx prisma generate`.

### Produkcja (Hetzner)

Na Hetzner (Ubuntu) `prisma db push` DZIAŁA normalnie — nie ma ograniczeń FreeBSD.

Można też ręcznie przez SSH:
```bash
ssh hetzner
cd /var/www/hotel
npx prisma db push
```

## 5. Prisma binaryTargets

W `prisma/schema.prisma`:

```prisma
binaryTargets = ["native", "freebsd14", "debian-openssl-3.0.x"]
```

- `native` — lokalny dev (Windows)
- `debian-openssl-3.0.x` — Hetzner (Ubuntu)
- `freebsd14` — MyDevil backup (zachowane dla kompatybilności)

## 6. Terminal — PowerShell na Windows

- Shell to PowerShell — nie używaj składni bash (`&&`, heredoc `<<EOF`).
- Łącz komendy przez `;` zamiast `&&`.
- Nie używaj `head`, `tail`, `grep` — to komendy linux, nie PowerShell.

## 7. SSH — klucze

**Hetzner:** `~/.ssh/hetzner_key` (skonfigurowany w `~/.ssh/config` jako host `hetzner`)
**MyDevil:** `~/.ssh/id_ed25519` (backup)

Agent może łączyć się przez SSH bez pytania o hasło (do diagnostyki, logów, prisma db push).

## 8. Nginx na Hetzner

Konfiguracja: `/etc/nginx/sites-available/hotel`
SSL: certbot automatyczny

Restart nginx:
```bash
ssh hetzner "systemctl reload nginx"
```

## 9. Troubleshooting Hetzner

```bash
ssh hetzner
pm2 logs hotel-pms --lines 50      # logi aplikacji
tail -50 /var/log/nginx/error.log  # logi nginx
systemctl status mariadb           # status bazy
```

**Sprawdzenie statusu GitHub Actions:** Wejdź na GitHub → repozytorium → Actions → ostatni workflow.

**Restart aplikacji ręcznie (przez SSH):**
```bash
ssh hetzner "pm2 restart hotel-pms"
```
